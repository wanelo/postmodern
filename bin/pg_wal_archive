#!/usr/bin/env ruby

# This script is a wrapper for a user-generated pg_wal_archive.local
# script. If that script does not exist, this executable does nothing
# and WAL files are not archived.
#
# This script (and the local script) should be executable as the
# postgres user.

ENV['WAL_ARCHIVE_FILE']=ARGV[0] # maps to %f in postgres archiving
ENV['WAL_ARCHIVE_PATH']=ARGV[1] # maps to %p in postgres archiving

puts "Archiving file: #{ENV['WAL_ARCHIVE_FILE']}"
puts "Archiving path: #{ENV['WAL_ARCHIVE_PATH']}"

def local_script_exists?
  `which pg_wal_archive.local >/dev/null 2>/dev/null`
  $?.exitstatus == 0
end

if local_script_exists?
  `pg_wal_archive.local`
end
