#!/usr/bin/env ruby

# This script is a wrapper for a user-generated pg_wal_archive.local
# script. If that script does not exist, this executable does nothing
# and WAL files are not archived.
#
# This script (and the local script) should be executable as the
# postgres user.

archive_path = ARGV[0]
archive_file = ARGV[1]

ENV['WAL_ARCHIVE_PATH']=archive_path # maps to %p in postgres archiving
ENV['WAL_ARCHIVE_FILE']=archive_file # maps to %f in postgres archiving

puts "Archiving file: #{archive_file}, path: #{archive_path}"

def local_script_exists?
  `which pg_wal_archive.local >/dev/null 2>/dev/null`
  $?.exitstatus == 0
end

if local_script_exists?
  `pg_wal_archive.local #{archive_path} #{archive_file}`
end
